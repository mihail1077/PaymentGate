@startuml

participant "Платёжная система"
participant "Почтовый сервер"
box "Платёжный шлюз"
participant "Адаптер платёжной системы"
participant "Почтовый модуль"
participant "Ядро платёжного шлюза"
end box

"Платёжная система" -> "Почтовый сервер": Реестр сверки
...

"Почтовый модуль" -> "Почтовый сервер": Получение реестра сверки
activate "Почтовый модуль"
activate "Почтовый сервер"
"Почтовый сервер" -> "Почтовый модуль": Реестр сверки
deactivate "Почтовый сервер"

"Почтовый модуль" -> "Адаптер платёжной системы": Преобразование реестра
activate "Адаптер платёжной системы"
"Адаптер платёжной системы" -> "Почтовый модуль": Канонический реестр
deactivate "Адаптер платёжной системы"

"Почтовый модуль" -> "Ядро платёжного шлюза": Реестр сверки
activate "Ядро платёжного шлюза"
"Ядро платёжного шлюза" -> "Ядро платёжного шлюза": Сохранение реестра
"Ядро платёжного шлюза" -> "Почтовый модуль": Реестр получен
deactivate "Почтовый модуль"

...

"Ядро платёжного шлюза" -> "Ядро платёжного шлюза": Сверка реестра
opt Если для платёжной системы включено доначисление
loop Для всех расхождений "Отсутствует в ПШ"
"Ядро платёжного шлюза" -> "Ядро платёжного шлюза": Платёж за услугу
end
end
deactivate "Ядро платёжного шлюза"

...
"Почтовый модуль" -> "Ядро платёжного шлюза": Запрос отчёта по сверке
activate "Почтовый модуль"
activate "Ядро платёжного шлюза"
"Ядро платёжного шлюза" -> "Почтовый модуль": Отчёт по сверке
deactivate "Ядро платёжного шлюза"
"Почтовый модуль" -> "Почтовый сервер": Отправка отчёта по сверке
deactivate "Почтовый модуль"

@enduml