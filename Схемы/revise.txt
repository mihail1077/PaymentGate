@startuml

participant "Платёжная система"
participant "Почтовый сервер"
participant "Адаптер платёжной системы"
participant "Платёжный шлюз"

"Платёжная система" -> "Почтовый сервер": Реестр сверки
...

"Адаптер платёжной системы" -> "Почтовый сервер": Получение реестра сверки
activate "Адаптер платёжной системы"
activate "Почтовый сервер"
"Почтовый сервер" -> "Адаптер платёжной системы": Реестр сверки
deactivate "Почтовый сервер"

"Адаптер платёжной системы" -> "Платёжный шлюз": Реестр сверки
activate "Платёжный шлюз"
"Платёжный шлюз" -> "Платёжный шлюз": Сохранение реестра
"Платёжный шлюз" -> "Адаптер платёжной системы": Реестр получен
deactivate "Адаптер платёжной системы"

...

"Платёжный шлюз" -> "Платёжный шлюз": Сверка реестра
opt Если для платёжной системы включено доначисление
loop Для всех расхождений "Отсутствует в ПШ"
"Платёжный шлюз" -> "Платёжный шлюз": Платёж за услугу
end
end
deactivate "Платёжный шлюз"

...
"Адаптер платёжной системы" -> "Платёжный шлюз": Запрос отчёта по сверке
activate "Адаптер платёжной системы"
activate "Платёжный шлюз"
"Платёжный шлюз" -> "Адаптер платёжной системы": Отчёт по сверке
deactivate "Платёжный шлюз"
"Адаптер платёжной системы" -> "Почтовый сервер": Отправка отчёта по сверке
deactivate "Адаптер платёжной системы"

@enduml